<header>
  <mat-toolbar color="primary">
    <button
      class="router-button"
      mat-icon-button
      [routerLink]="['/events', eventId]"
    >
      <mat-icon>close</mat-icon>
    </button>
    <h1>
      {{
        isEdit
          ? ("purchase.edit.title" | transloco)
          : ("purchase.new.title" | transloco)
      }}
    </h1>
    <span class="spacer"></span>
    <button
      mat-icon-button
      form="purchaseForm"
      [disabled]="purchaseForm.invalid"
    >
      <mat-icon>check</mat-icon>
    </button>
  </mat-toolbar>
</header>

<div *ngIf="loading$ | async; else form">
  <spinner></spinner>
</div>

<ng-template #form>
  <main class="container" *ngIf="event">
    <div *ngIf="hasRePayedDebts" class="mat-form-field-invalid hasRePayedDebts">
      {{ "purchase.afterStartRepayDebts" | transloco }}
    </div>

    <form [formGroup]="purchaseForm" (ngSubmit)="onSubmit()" id="purchaseForm">
      <mat-form-field class="full-width">
        <mat-label>{{ "purchase.name" | transloco }}</mat-label>
        <input matInput formControlName="title" type="text" required />
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label>{{ "common.sum" | transloco }}</mat-label>
        <input matInput formControlName="sum" numbersOnly required />
      </mat-form-field>

      <div
        *ngIf="purchaseForm.errors?.minimalSum"
        class="mat-form-field-invalid"
      >
        {{ "purchase.minimalSum" | transloco }}
      </div>

      <mat-form-field class="full-width">
        <mat-label>{{ "purchase.whoPaid" | transloco }}</mat-label>
        <mat-select formControlName="payer" required>
          <mat-option *ngFor="let member of event.members" [value]="member">
            {{ member }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <separator position="outer"></separator>
      <grey-title
        *transloco="let t"
        [text]="t('purchase.members')"
      ></grey-title>

      <div formArrayName="members">
        <div
          *ngIf="purchaseForm.errors?.minimalMembersCount"
          class="mat-form-field-invalid"
        >
          {{ "purchase.needOneMember" | transloco }}
        </div>

        <div
          *ngFor="let member of members.controls; let i = index"
          [formGroupName]="i"
        >
          <mat-checkbox color="primary" formControlName="selected">
            <span class="label">{{ member.get("name")?.value }}</span>
          </mat-checkbox>
        </div>
      </div>
    </form>

    <div *ngIf="isEdit && !hasRePayedDebts">
      <separator position="outer"></separator>
      <button
        class="delete-purchase-button"
        (click)="onDeletePurchase()"
        mat-raised-button
        color="basic"
      >
        <mat-icon>close</mat-icon>{{ "purchase.delete" | transloco }}
      </button>
    </div>
  </main>
</ng-template>
